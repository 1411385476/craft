#include <stdio.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <stddef.h>
#include <sys/un.h>
#include <time.h>

#define MSGLEN 512
#define oops(m,x){ perror(m); return 0; }
#define SOCKNAME "/var/log/log.socket"

int accept(int ac, char * av[])
{
	int 		sock,client_fd;
	struct 		sockaddr_un addr;
	socklen_t 	addrlen;
	char		msg[MSGLEN];
	int 		l;
	char sockname[]	= SOCKNAME;
	time_t		now;
	int  msgnum	= 0;
	char 		* timestr;
	
	/**/
	addr.sun_family	= AF_UNIX;
	strcpy(addr.sun_path,sockname);
	
	sock	= socket(AF_UNIX,SOCK_STREAM,0);
	
	addrlen = offsetof(struct sockaddr_un, sun_path)+ strlen(addr.sun_path);
	
	unlink(sockname);
	
	if(bind(sock,(struct sockaddr *) &addr,addrlen) == -1){
		oops("bind",3);
	}
	listen(sock,6);
	client_fd = accept(sock,(struct sockaddr *) &addr,(socklen_t *)&addrlen);
	//
	while(1){
		l = read(client_fd,msg,MSGLEN);
		msg[l] = '\0';
		time(&now);
		timestr = ctime(&now);
		timestr[strlen(timestr)-1] = '\0';
		printf("[%5d] %s %s\n",msgnum++,timestr,msg);
		fflush(stdout);
	}
	return 0;
}
